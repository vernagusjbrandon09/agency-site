import React, { useState, useEffect } from 'react';
import { 
  ShieldCheck, 
  Mail, 
  Lock,
  CheckCircle2,
  Calculator,
  ArrowRight,
  Target,
  Shield,
  MapPin,
  Scale,
  Star
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  serverTimestamp
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pathway-bridge-v1';

export default function App() {
  const [page, setPage] = useState('home');
  const [user, setUser] = useState(null);
  const [inquiries, setInquiries] = useState([]);
  const [isAdminMode, setIsAdminMode] = useState(false);
  const [notification, setNotification] = useState(null);

  // Auth Lifecycle (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth failed:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Data Fetching (Rule 1 & 2)
  useEffect(() => {
    if (!user || !isAdminMode) return;
    
    const inquiryCollection = collection(db, 'artifacts', appId, 'public', 'data', 'inquiries');
    const unsubscribe = onSnapshot(inquiryCollection, 
      (snapshot) => {
        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const sorted = docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        setInquiries(sorted);
      },
      (err) => console.error("Firestore Error:", err)
    );
    return () => unsubscribe();
  }, [user, isAdminMode]);

  const showToast = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 4000);
  };

  const handleInquirySubmit = async (formData) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inquiries'), {
        ...formData,
        timestamp: serverTimestamp(),
        userId: user.uid,
        status: 'unread',
        location: 'Mesa Area'
      });
      showToast("Submission successful!");
      setPage('home');
      window.scrollTo(0,0);
    } catch (err) {
      console.error(err);
      showToast("Submission failed.");
    }
  };

  const renderContent = () => {
    switch(page) {
      case 'employer': return <EmployerPage onSubmit={handleInquirySubmit} />;
      case 'jobseeker': return <JobSeekerPage onSubmit={handleInquirySubmit} />;
      case 'compliance': return <CompliancePage />;
      case 'admin': return <AdminPanel inquiries={inquiries} exit={() => setPage('home')} />;
      case 'about': return <AboutPage />;
      default: return <HomePage setPage={setPage} />;
    }
  };

  return (
    <div className="min-h-screen bg-white text-slate-900 font-sans selection:bg-indigo-600 selection:text-white overflow-x-hidden">
      {/* Toast Notification */}
      {notification && (
        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[100] bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3">
          <CheckCircle2 size={18} className="text-emerald-400" />
          <span className="font-bold text-sm uppercase tracking-widest">{notification}</span>
        </div>
      )}

      {/* Navigation */}
      <nav className="fixed top-0 w-full z-50 bg-white border-b border-slate-100 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 md:px-6 h-20 flex items-center justify-between">
          <div 
            className="flex items-center gap-2 cursor-pointer group shrink-0"
            onClick={() => {setPage('home'); window.scrollTo(0,0);}}
          >
            <div className="bg-indigo-600 p-2 rounded-lg shadow-lg">
              <ShieldCheck className="text-white" size={20} />
            </div>
            <span className="font-black text-lg md:text-xl tracking-tighter uppercase italic whitespace-nowrap">
              Pathway<span className="text-indigo-600">Bridge</span>
            </span>
          </div>

          <div className="hidden lg:flex items-center gap-8">
            {['Employer', 'JobSeeker', 'Compliance', 'About'].map((item) => (
              <button 
                key={item}
                onClick={() => setPage(item.toLowerCase())}
                className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 hover:text-indigo-600 transition-colors"
              >
                {item}
              </button>
            ))}
          </div>

          <div className="flex items-center gap-2 md:gap-4">
            <button 
              onClick={() => {setIsAdminMode(true); setPage('admin');}}
              className="p-2 text-slate-300 hover:text-slate-900"
            >
              <Lock size={16} />
            </button>
            <button 
              onClick={() => setPage('employer')}
              className="bg-indigo-600 text-white px-4 md:px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-900 shadow-lg shadow-indigo-100 whitespace-nowrap"
            >
              Hire Talent
            </button>
          </div>
        </div>
      </nav>

      <main className="pt-20">
        {renderContent()}
      </main>

      {/* Updated Footer with the new email */}
      <footer className="bg-slate-50 border-t border-slate-100 pt-20 pb-12 px-6">
        <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-12">
          <div className="md:col-span-2">
            <h4 className="font-black text-2xl uppercase italic mb-4">Pathway<span className="text-indigo-600">Bridge</span></h4>
            <p className="text-slate-500 font-medium max-w-sm leading-relaxed">
              Empowering Mesa and the Greater Arizona region. Connecting high-demand industries with loyal, fair-chance talent.
            </p>
          </div>
          <div className="space-y-4">
            <h5 className="font-black uppercase tracking-widest text-xs text-slate-400">Directory</h5>
            <ul className="space-y-2 font-bold text-sm">
              <li><button onClick={() => setPage('employer')} className="hover:text-indigo-600">Employers</button></li>
              <li><button onClick={() => setPage('jobseeker')} className="hover:text-indigo-600">Job Seekers</button></li>
              <li><button onClick={() => setPage('compliance')} className="hover:text-indigo-600">Compliance</button></li>
            </ul>
          </div>
          <div className="space-y-4">
            <h5 className="font-black uppercase tracking-widest text-xs text-slate-400">Contact Us</h5>
            <ul className="space-y-3 font-bold text-sm text-slate-500">
              <li className="flex items-start gap-2">
                <Mail size={16} className="mt-1 shrink-0" /> 
                <a href="mailto:contactpathwaybridesolutions@gmail.com" className="hover:text-indigo-600 break-all transition-colors">
                  contactpathwaybridesolutions@gmail.com
                </a>
              </li>
              <li className="flex items-center gap-2"><MapPin size={16} /> Mesa, Arizona</li>
            </ul>
          </div>
        </div>
        <div className="max-w-7xl mx-auto mt-16 pt-8 border-t border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 text-[10px] font-black uppercase tracking-widest text-slate-400">
          <p>© 2026 Pathway Bridge Solutions LLC.</p>
          <div className="flex gap-6">
            <button className="hover:text-slate-900">Privacy</button>
            <button className="hover:text-slate-900">Terms</button>
          </div>
        </div>
      </footer>
    </div>
  );
}

// --- Page Components ---

function HomePage({ setPage }) {
  return (
    <div className="animate-in fade-in duration-700">
      <section className="relative px-6 pt-24 pb-32 md:pb-48 overflow-hidden bg-white">
        <div className="max-w-7xl mx-auto relative z-10">
          <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full font-black text-[10px] uppercase tracking-widest mb-8 border border-indigo-100">
            <MapPin size={14} /> Headquartered in Mesa, AZ
          </div>
          <h1 className="text-5xl md:text-8xl lg:text-[7rem] font-black tracking-tighter leading-[0.9] text-slate-900 mb-8 uppercase">
            Strength <br/>
            <span className="text-indigo-600">In Loyalty.</span>
          </h1>
          <p className="text-lg md:text-2xl text-slate-500 max-w-3xl font-medium leading-relaxed mb-12">
            Mesa's premier fair-chance staffing agency. We provide a vetted, high-loyalty workforce to industrial leaders, significantly reducing turnover.
          </p>
          <div className="flex flex-col sm:flex-row gap-4">
            <button 
              onClick={() => setPage('employer')}
              className="bg-indigo-600 text-white px-10 py-5 rounded-2xl font-black text-lg hover:bg-slate-900 transition-all flex items-center justify-center gap-3 shadow-xl shadow-indigo-100"
            >
              Hire Talent <ArrowRight size={20} />
            </button>
            <button 
              onClick={() => setPage('jobseeker')}
              className="bg-white border-2 border-slate-100 text-slate-900 px-10 py-5 rounded-2xl font-black text-lg hover:border-indigo-600 transition-all"
            >
              Find a Job
            </button>
          </div>
        </div>
      </section>

      <section className="py-20 bg-slate-900 text-white">
        <div className="max-w-7xl mx-auto px-6 grid grid-cols-2 lg:grid-cols-4 gap-8 text-center">
          <div>
            <p className="text-4xl md:text-5xl font-black mb-1">91%</p>
            <p className="text-indigo-400 font-black text-[10px] uppercase tracking-widest">Retention Rate</p>
          </div>
          <div>
            <p className="text-4xl md:text-5xl font-black mb-1">$9.6K</p>
            <p className="text-indigo-400 font-black text-[10px] uppercase tracking-widest">WOTC Potential</p>
          </div>
          <div>
            <p className="text-4xl md:text-5xl font-black mb-1">40%</p>
            <p className="text-indigo-400 font-black text-[10px] uppercase tracking-widest">Lower Turnover</p>
          </div>
          <div>
            <p className="text-4xl md:text-5xl font-black mb-1">100%</p>
            <p className="text-indigo-400 font-black text-[10px] uppercase tracking-widest">Mesa Focused</p>
          </div>
        </div>
      </section>

      <section className="py-24 bg-slate-50 px-6">
        <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
          <FeatureCard icon={<Shield size={32} />} title="Federal Bonding" desc="We manage DOL bonding to eliminate liability for your business." />
          <FeatureCard icon={<Calculator size={32} />} title="Tax Credits" desc="Full assistance in capturing WOTC tax incentives for every hire." />
          <FeatureCard icon={<Target size={32} />} title="Retention" desc="Post-placement coaching ensures long-term employee success." />
        </div>
      </section>
    </div>
  );
}

function EmployerPage({ onSubmit }) {
  return (
    <div className="animate-in slide-in-from-bottom-5 duration-700 bg-white">
      <div className="max-w-7xl mx-auto px-6 py-20 grid lg:grid-cols-2 gap-16 items-start">
        <div className="pt-10">
          <h1 className="text-5xl md:text-7xl font-black text-slate-900 tracking-tighter uppercase mb-6 leading-none">
            Scale Your <span className="text-indigo-600">Workforce.</span>
          </h1>
          <p className="text-xl text-slate-500 font-medium leading-relaxed mb-10">
            Partner with Mesa's experts in fair-chance employment. Secure the labor you need while benefiting from tax incentives and DOL bonding.
          </p>
          <div className="space-y-6">
            <FeatureLine title="Vetted Talent" desc="Every candidate undergoes a local screening process." />
            <FeatureLine title="Compliance Handled" desc="We manage the paperwork and EEOC guidelines." />
            <FeatureLine title="Turnover Reduction" desc="Access a more grateful and loyal talent pool." />
          </div>
        </div>
        <InquiryForm type="employer" onSubmit={onSubmit} />
      </div>
    </div>
  );
}

function JobSeekerPage({ onSubmit }) {
  return (
    <div className="animate-in slide-in-from-bottom-5 duration-700 bg-white">
      <div className="max-w-7xl mx-auto px-6 py-20 grid lg:grid-cols-2 gap-16 items-start">
        <div className="pt-10">
          <h1 className="text-5xl md:text-7xl font-black text-slate-900 tracking-tighter uppercase mb-6 leading-none">
            A New <span className="text-indigo-600">Beginning.</span>
          </h1>
          <p className="text-xl text-slate-500 font-medium leading-relaxed mb-10">
            Your past shouldn't stop your future. We work with employers in Mesa who value your hard work over your history.
          </p>
          <div className="bg-slate-900 p-10 rounded-3xl text-white">
             <h3 className="font-black uppercase tracking-widest text-indigo-400 text-xs mb-6">Candidate Benefits</h3>
             <ul className="space-y-6">
               <li><h4 className="font-bold text-lg mb-1">Direct Placement</h4><p className="text-slate-400 text-sm">Real jobs at real Mesa companies.</p></li>
               <li><h4 className="font-bold text-lg mb-1">Career Mentorship</h4><p className="text-slate-400 text-sm">Support for your first 90 days on the job.</p></li>
               <li><h4 className="font-bold text-lg mb-1">Skills Training</h4><p className="text-slate-400 text-sm">Access to local industrial certifications.</p></li>
             </ul>
          </div>
        </div>
        <InquiryForm type="jobseeker" onSubmit={onSubmit} />
      </div>
    </div>
  );
}

function CompliancePage() {
  return (
    <div className="py-24 px-6 max-w-4xl mx-auto">
      <h1 className="text-4xl md:text-6xl font-black uppercase tracking-tighter mb-8 text-center">Compliance Hub</h1>
      <div className="space-y-12">
        <section className="bg-slate-50 p-10 rounded-3xl border border-slate-100">
          <div className="flex items-center gap-4 text-indigo-600 mb-6">
            <Scale size={32} />
            <h2 className="text-2xl font-black uppercase tracking-tighter">Legal Standards</h2>
          </div>
          <p className="text-slate-600 font-medium text-lg leading-relaxed">
            Pathway Bridge Solutions LLC operates in full compliance with the EEOC Enforcement Guidance and Arizona fair chance employment laws. We handle the "individualized assessment" requirements for you.
          </p>
        </section>
      </div>
    </div>
  );
}

function AdminPanel({ inquiries, exit }) {
  const [pass, setPass] = useState('');
  const [isAuthed, setIsAuthed] = useState(false);

  if (!isAuthed) {
    return (
      <div className="min-h-[60vh] flex items-center justify-center px-6">
        <div className="bg-white p-10 rounded-3xl shadow-2xl border border-slate-100 w-full max-w-md text-center">
          <h2 className="text-2xl font-black mb-8 uppercase tracking-tighter">Admin Access</h2>
          <input 
            type="password"
            placeholder="PIN"
            className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl text-center font-black text-xl mb-6 outline-none"
            onChange={(e) => { if (e.target.value === 'admin123') setIsAuthed(true); }}
          />
        </div>
      </div>
    );
  }

  return (
    <div className="py-16 max-w-7xl mx-auto px-6">
      <div className="flex justify-between items-center mb-10">
        <h2 className="text-3xl font-black uppercase italic">Leads</h2>
        <button onClick={exit} className="text-xs font-black uppercase tracking-widest text-slate-400">Exit</button>
      </div>
      <div className="grid gap-4">
        {inquiries.map((iq) => (
          <div key={iq.id} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
            <div className="flex justify-between mb-2">
               <span className="text-[10px] font-black uppercase text-indigo-600">{iq.type}</span>
               <span className="text-[10px] font-bold text-slate-400">{iq.timestamp ? new Date(iq.timestamp.seconds * 1000).toLocaleDateString() : 'recent'}</span>
            </div>
            <h3 className="font-black text-lg">{iq.name}</h3>
            <p className="text-sm font-bold text-slate-500 mb-4">{iq.email} • {iq.phone}</p>
            <p className="text-sm text-slate-600 bg-slate-50 p-4 rounded-xl italic">"{iq.details}"</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- Shared UI Components ---

function FeatureCard({ icon, title, desc }) {
  return (
    <div className="p-8 bg-white rounded-3xl border border-slate-100 shadow-sm">
      <div className="text-indigo-600 mb-6">{icon}</div>
      <h4 className="text-xl font-black text-slate-900 mb-3 uppercase tracking-tighter">{title}</h4>
      <p className="text-slate-500 font-medium text-sm leading-relaxed">{desc}</p>
    </div>
  );
}

function FeatureLine({ title, desc }) {
  return (
    <div className="flex gap-4 items-start">
      <CheckCircle2 size={18} className="text-indigo-600 mt-1 shrink-0" />
      <div>
        <p className="font-black uppercase tracking-widest text-[10px] text-slate-900">{title}</p>
        <p className="text-slate-500 text-sm font-medium">{desc}</p>
      </div>
    </div>
  );
}

function InquiryForm({ type, onSubmit }) {
  const [fd, setFd] = useState({ name: '', email: '', phone: '', details: '', type });
  const [loading, setLoading] = useState(false);

  const submit = async (e) => {
    e.preventDefault();
    setLoading(true);
    await onSubmit(fd);
    setLoading(false);
  };

  return (
    <form onSubmit={submit} className="bg-slate-50 p-8 md:p-12 rounded-[2.5rem] border border-slate-100 flex flex-col gap-6 shadow-sm">
      <h3 className="text-2xl font-black text-slate-900 uppercase tracking-tighter mb-2">Connect in Mesa</h3>
      <input required placeholder="Name" className="p-5 rounded-xl border border-slate-200 outline-none focus:border-indigo-600 font-bold" onChange={e => setFd({...fd, name: e.target.value})} />
      <input required type="email" placeholder="Email" className="p-5 rounded-xl border border-slate-200 outline-none focus:border-indigo-600 font-bold" onChange={e => setFd({...fd, email: e.target.value})} />
      <input required type="tel" placeholder="Phone" className="p-5 rounded-xl border border-slate-200 outline-none focus:border-indigo-600 font-bold" onChange={e => setFd({...fd, phone: e.target.value})} />
      <textarea required placeholder="How can we help?" className="p-5 rounded-xl border border-slate-200 outline-none focus:border-indigo-600 font-bold min-h-[120px]" onChange={e => setFd({...fd, details: e.target.value})}></textarea>
      <button disabled={loading} className="py-5 bg-indigo-600 text-white rounded-xl font-black uppercase tracking-widest text-xs hover:bg-slate-900 disabled:opacity-50 transition-colors">
        {loading ? 'Sending...' : 'Send Inquiry'}
      </button>
    </form>
  );
}

function AboutPage() {
  return (
    <div className="py-20 px-6 max-w-7xl mx-auto">
      <div className="grid lg:grid-cols-2 gap-16 items-center">
        <div>
          <h1 className="text-5xl md:text-7xl font-black text-slate-900 uppercase tracking-tighter mb-8 leading-none">Our <span className="text-indigo-600">Mission.</span></h1>
          <p className="text-xl text-slate-500 font-medium leading-relaxed mb-10">
            Pathway Bridge Solutions LLC was built on the foundation of second chances. We believe the strongest companies in Mesa are built by the most loyal employees.
          </p>
          <div className="flex gap-4">
             <div className="bg-indigo-50 p-6 rounded-2xl flex-1 text-center">
                <Star className="mx-auto text-indigo-600 mb-2" size={24} />
                <p className="font-black text-[10px] uppercase tracking-widest">Quality Placements</p>
             </div>
             <div className="bg-indigo-50 p-6 rounded-2xl flex-1 text-center">
                <ShieldCheck className="mx-auto text-indigo-600 mb-2" size={24} />
                <p className="font-black text-[10px] uppercase tracking-widest">Risk Protected</p>
             </div>
          </div>
        </div>
        <div className="bg-slate-900 p-12 rounded-[3rem] text-white">
           <h3 className="text-3xl font-black uppercase italic mb-8">The Mesa Standard</h3>
           <p className="text-slate-400 font-medium text-lg leading-relaxed">
             We don't just staff; we bridge the gap between high-demand industrial jobs and motivated workers. Our presence in the Mesa community ensures local support for both the business and the employee.
           </p>
        </div>
      </div>
    </div>
  );
}
